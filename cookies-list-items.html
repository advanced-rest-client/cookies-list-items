<!--
@license
Copyright 2016 The Advanced REST client authors <arc@mulesoft.com>
Licensed under the Apache License, Version 2.0 (the "License"); you may not
use this file except in compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-item/paper-icon-item.html">
<link rel="import" href="../paper-item/paper-item-body.html">
<link rel="import" href="../paper-tooltip/paper-tooltip.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../iron-list/iron-list.html">
<!--
`<cookies-list-items>` An element to display a list of cookies

## Data model
Each cookie item requires following properties:
-   `name` (String) Cookie name
-   `value` (String) Cookie value
-   `domain` (String) Cookie domain
-   `path` (String) Cookie path.


### Example

```
<cookies-list-items items="[[cookies]]"></cookies-list-items>
```

## List handling

The element uses `<iron-list>` element that creates a virtual list containing
limited number of child elements. It allows to load huge number of requests
without influencing the performance.

### Styling
`<cookies-list-items>` provides the following custom properties and mixins for styling:

Custom property | Description | Default
----------------|-------------|----------
`--cookies-list-items` | Mixin applied to the element | `{}`
`--action-button` | Mixin apllied to the primary action buttons | `{}`
`--secondary-action-button-color` | Color of the secondary action button | `--primary-color`
`--arc-font-body1` | Mixin applied to the element | `{}`
`--cookies-list-item` | Mixin applied to each list item | `{}`
`--cookies-list-item-selected` | Mixin applied to the selected list item | `{}`
`--cookies-list-item-selected-background-color` | Selection color for list items. | `#E0E0E0`
`--cookies-list-items-search-input` | Mixin applied to the search input | `{}`
`--cookies-list-items-header` | Mixin applied to the list header options section. | `{}`
`--cookies-list-items-list` | Mixin applied to the list (`iron-list`) | `{}`
`--cookies-list-item-value` | Mixin applied to cookie value label | `{}`
`--cookies-list-item-name` |  Mixin applied to cookie name label. Note that name label is a child of value container. | `{}`
`--cookies-list-item-url-color` | Color of the cookie domain and path labels | `rgba(0, 0, 0, 0.54)`

@group UI Elements
@element cookies-list-items
@demo demo/index.html
-->
<dom-module id="cookies-list-items">
  <template>
    <style>
     :host {
      display: block;
      color: rgba(0, 0, 0, 0.87);
      @apply --arc-font-body1;
      @apply --layout-vertical;
      @apply --cookies-list-items;
    }

    .cookie-item>paper-icon-item {
      @apply --cookies-list-item;
    }

    .cookie-item.selected>paper-icon-item {
      background-color: var(--cookies-list-item-selected-background-color, #E0E0E0);
      @apply --cookies-list-item-selected;
    }

    paper-item-body {
      @apply --cookies-list-items-body;
    }

    .table-options {
      @apply --layout-horizontal;
      @apply --layout-center;
      padding-left: 16px;
      padding-bottom: 24px;
      margin: 24px 0;
      @apply --cookies-list-items-header;
    }

    .table-options .hiddable {
      opacity: 1;
      transition: opacity 0.2s cubic-bezier(0.47, 0, 0.75, 0.72);
    }

    .table-options.inactive .hiddable {
      pointer-events: none;
      opacity: 0;
    }

    .main-action {
      @apply --action-button;
      height: 36px;
      font-size: 14px;
    }

    .secondary-action {
      color: var(--secondary-action-button-color, --primary-color);
      height: 36px;
      font-size: 14px;
    }

    .selected-counter {
      display: inline-block;
      margin-left: 8px;
      font-size: 16px;
      @apply --cookies-list-items-selection-counter;
    }

    .selected-actions {
      margin-left: 24px;
      @apply --layout-flex;
    }

    .search {
      margin-right: 12px;
    }

    .search>paper-input {
      @apply --cookies-list-items-search-input;
    }

    .empty-info {
      margin-left: 16px;
      font-size: 16px;
      @apply --empty-info;
    }

    .cookie-value {
      @apply --cookies-list-item-value;
    }

    .cookie-name {
      font-weight: 500;
      margin-right: 12px;
      @apply --cookies-list-item-name;
    }

    div[secondary] {
      color: var(--cookies-list-item-url-color, rgba(0, 0, 0, 0.54));
    }
    </style>
    <section class$="table-options [[_computeOptionsTableClass(hasSelection)]]">
      <span>
        <paper-checkbox class="select-all" checked="{{allSelected}}"></paper-checkbox>
        <paper-tooltip animation-delay="200" position="right" offset="0">Select / deselect all</paper-tooltip>
      </span>
      <span class="selected-counter hiddable">[[selectedItems.length]] item(s) selected</span>
      <div class="selected-actions hiddable">
        <paper-button class="main-action" data-action="export-all" raised on-tap="_exportSelected">Export</paper-button>
        <paper-button class="secondary-action" data-action="delete-all" on-tap="_deleteSelected">Delete</paper-button>
      </div>
      <div class="search">
        <paper-input label="Search" no-label-float value="{{keyword}}" type="search" on-search="_searchList"></paper-input>
      </div>
    </section>
    <template is="dom-if" if="[[empty]]">
      <p class="empty-info">No items to display.</p>
    </template>
    <iron-list id="list" items="[[items]]" selected-items="{{selectedItems}}" multi-selection selection-enabled hidden$="[[empty]]">
      <template>
        <div class="item-wrapper">
          <div class$="cookie-item [[_computeRowClass(selected)]]">
            <paper-icon-item tabindex$="[[tabIndex]]" aria-label$="Select/Deselect [[item.url]]">
              <paper-checkbox data-action="select-item" checked="{{selected}}" item-icon></paper-checkbox>
              <paper-item-body two-line>
                <div class="cookie-value"><span class="cookie-name">[[item.name]]:</span>[[item.value]]</div>
                <div secondary>
                  [[item.domain]] [[item.path]]
                </div>
              </paper-item-body>
              <paper-button class="secondary-action" data-action="item-detail" on-tap="_cookieDetails">Details</paper-button>
            </paper-icon-item>
          </div>
        </div>
      </template>
    </iron-list>
    <paper-toast text="Select list item first" id="noSelectionToast"></paper-toast>
  </template>
  <script>
  Polymer({
    is: 'cookies-list-items',
    properties: {
      // The list of cookie items to render.
      items: Array,
      // List of selected items on the list.
      selectedItems: {
        type: Array,
        notify: true
      },
      /**
       * If true, the user selected some elements on list. Check the
       * `this.selectedItems` property to check for the selected elements.
       */
      hasSelection: {
        type: Boolean,
        value: false,
        computed: '_computeHasSelection(selectedItems.length)',
        notify: true
      },
      // True to select / deselect all elements from the list
      allSelected: Boolean,
      // Filter keyword for search
      keyword: {
        type: String,
        notify: true
      },
      /**
       * If set the empty message will appear instead of list.
       * This property is not computed by the element because of complex
       * conditions that exists outside the scope of this element.
       */
      empty: {
        type: Boolean,
        value: false
      }
    },
    listeners: {
      'iron-select': '_onSelectItem',
      'iron-deselect': '_onSelectItem',
      'iron-activate': '_onSelectItem',
      'iron-changed': '_onSelectItem',
      'iron-change': '_onSelectItem'
    },

    observers: [
      '_sizeChanged(items.length)',
      '_toggleSelectAll(allSelected)'
    ],

    hostAttributes: {
      'role': 'list'
    },
    // Notifies the list about the change. It re-renders the items.
    refresh: function() {
      this.$.list.fire('iron-resize');
    },

    _sizeChanged: function(length) {
      if (length) {
        this.async(() => {
          this.refresh();
        }, 1);
      }
    },
    // Computes selection class name for a row of the table.
    _computeRowClass: function(selected) {
      return selected ? 'selected' : '';
    },

    // Called to request details panel for the list item
    _cookieDetails: function(e) {
      var item = e.model.get('item');
      this.fire('list-item-details', {
        item: item
      }, {
        bubbles: false
      });
    },

    // Computes `hasSelection` property based on selection length
    _computeHasSelection: function(length) {
      return !!length;
    },
    /**
     * Toggles selection of of all itmes on the list.
     * @param {Boolean} allSelected Current state of the `allSelected` property.
     */
    _toggleSelectAll: function(allSelected) {
      var selectedItems = this.selectedItems;
      var items = this.items;
      if (!selectedItems || !items) {
        return;
      }
      if (allSelected) {
        if (selectedItems.length === items.length) {
          return;
        }
        items.forEach(item => this.$.list.selectItem(item));
      } else {
        if (selectedItems.length === 0) {
          return;
        }
        items.forEach(item => this.$.list.deselectItem(item));
      }
    },
    _computeOptionsTableClass: function(hasSelection) {
      return hasSelection ? '' : ' inactive';
    },
    /**
     * Informs hosting application to delete currently selected items.
     */
    _deleteSelected: function() {
      var selected = this.selectedItems;
      if (!selected || !selected.length) {
        this.$.noSelectionToast.opened = true;
        return;
      }
      this.__deleteItems(selected);
    },
    // Fires `list-items-delete` event to inform hosting application to remove items.
    __deleteItems: function(items) {
      this.fire('list-items-delete', {
        items: items
      }, {
        bubbles: false
      });
    },
    // Fires `list-items-export` event to export current selection.
    _exportSelected: function() {
      var selected = this.selectedItems;
      if (!selected || !selected.length) {
        this.$.noSelectionToast.opened = true;
        return;
      }
      this.fire('list-items-export', {
        items: selected,
      }, {
        bubbles: false
      });
    },
    // Fires the `list-items-search` with current filter value.
    _searchList: function() {
      this.fire('list-items-search', {
        q: this.keyword,
      }, {
        bubbles: false
      });
    },
    // Handler for the selection related events.
    _onSelectItem: function(e) {
      e = Polymer.dom(e);
      var model = this.$.list.modelForElement(e.rootTarget);
      if (!model) {
        return;
      }
      var item = model.get('item');
      var selected = e.rootTarget.checked;
      if (selected) {
        this.$.list.selectItem(item);
      } else {
        this.$.list.deselectItem(item);
      }
      this.fire('list-items-selection-changed', {
        item: item,
        index: model.get('index'),
        selected: selected
      }, {
        bubbles: false
      });
    }
  });
  </script>
</dom-module>
